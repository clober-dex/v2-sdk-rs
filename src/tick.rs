use alloy::primitives::U256;

use crate::constants::{
    max_price, MAX_TICK, min_price, MIN_TICK, PRICE_PRECISION, q192_one, q96_one,
};
use crate::utils::math::{i256_to_i128, i256_u, ln_wad};

const R0: u128 = 0x0fff_9727_2373_d413_259a_4699_0;
const R1: u128 = 0x0fff_2e50_f5f6_5693_2ef1_2357_c;
const R2: u128 = 0x0ffe_5cac_a7e1_0e4e_61c3_624e_a;
const R3: u128 = 0x0ffc_b984_3d60_f615_9c9d_b588_3;
const R4: u128 = 0x0ff9_73b4_1fa9_8c08_1472_e689_6;
const R5: u128 = 0x0ff2_ea16_466c_96a3_843e_c78b_3;
const R6: u128 = 0x0fe5_dee0_46a9_9a2a_811c_461f_1;
const R7: u128 = 0x0fcb_e86c_7900_a88a_edcf_fc83_b;
const R8: u128 = 0x0f98_7a72_53ac_4131_76f2_b074_c;
const R9: u128 = 0x0f33_92b0_822b_7000_5940_c7a3_9;
const R10: u128 = 0x0e71_5947_5a2c_29b7_443b_29c7_f;
const R11: u128 = 0x0d09_7f3b_dfd2_022b_8845_ad8f_7;
const R12: u128 = 0x0a9f_7464_62d8_70fd_f8a6_5dc1_f;
const R13: u128 = 0x070d_869a_156d_2a1b_890b_b3df_6;
const R14: u128 = 0x031b_e135_f97d_08fd_9812_3150_5;
const R15: u128 = 0x009a_a508_b5b7_a84e_1c67_7de5_4;
const R16: u128 = 0x0005_d6af_8ded_b811_9669_9c32_9;
const R17: u128 = 0x0000_2216_e584_f5fa_1ea9_2604;
const R18: u128 = 0x0000_048a_1703_91f7_dc42;

#[inline]
pub fn invert_tick(tick: i128) -> i128 {
    -tick
}

#[inline]
pub fn invert_price(price: U256) -> U256 {
    if price.is_zero() { U256::ZERO } else { q192_one() / price }
}

pub fn from_price(price: U256) -> i128 {
    if price > max_price() || price < min_price() {
        panic!("price is out of range");
    }
    // (lnWad(price) * 42951820407860) >> 128
    let t = (ln_wad(price) * i256_u(42_951_820_407_860u128)) >> 128;
    let tick: i128 = i256_to_i128(t);
    if to_price(tick) > price { tick - 1 } else { tick }
}

pub fn to_price(tick: i128) -> U256 {
    if tick > MAX_TICK || tick < MIN_TICK {
        panic!("tick is out of range");
    }

    let abs_tick = if tick < 0 { -tick } else { tick } as u128;

    let mut price = if (abs_tick & 0x1) != 0 { U256::from(R0) } else { q96_one() };

    macro_rules! step {
        ($mask:expr, $r:expr) => {
            if (abs_tick & $mask) != 0 {
                price = (price * U256::from($r)) >> PRICE_PRECISION;
            }
        };
    }

    step!(0x2, R1);
    step!(0x4, R2);
    step!(0x8, R3);
    step!(0x10, R4);
    step!(0x20, R5);
    step!(0x40, R6);
    step!(0x80, R7);
    step!(0x100, R8);
    step!(0x200, R9);
    step!(0x400, R10);
    step!(0x800, R11);
    step!(0x1000, R12);
    step!(0x2000, R13);
    step!(0x4000, R14);
    step!(0x8000, R15);
    step!(0x1_0000, R16);
    step!(0x2_0000, R17);
    step!(0x4_0000, R18);

    if tick > 0 {
        price = (U256::from(1u8) << (PRICE_PRECISION * 2)) / price;
    }
    price
}

#[cfg(test)]
mod tests {
    use alloy::primitives::U256;

    use crate::tick::to_price;

    #[test]
    fn test_to_price() {
        let data = vec![
            ["-524287", "1350587"],
            ["-267931", "183385868605749282"],
            ["-448179", "2727005831"],
            ["334737", "27264400890855563488123541242372721541004056"],
            ["365134", "569711378857498594112410348900594582079166177"],
            ["441333", "1160833582114384562349918409490001486418475525566"],
            ["99102", "1594445119075323897439082216696143"],
            ["396340", "12907629635266058048078868238786028202291855038"],
            ["-294177", "13291486610403359"],
            ["-388817", "1031848829441"],
            ["313150", "3148700356240539920662738916950527539424993"],
            ["-22896", "8027284450892716121643090134"],
            ["-116337", "702555236863293357878547"],
            ["211468", "120881256975845501804629331045336917436"],
            ["-105867", "2001539033955480205204352"],
            ["224356", "438580897089966370401246217348001017668"],
            ["-112052", "1078366422785137828152008"],
            ["-255550", "632468618067437446"],
            ["-337370", "176937215574232"],
            ["-60353", "189632662732835586422454213"],
            ["499854", "403810523579860954524916572580253799910101374578081"],
            ["-394878", "562863841997"],
            ["-419530", "47844731482"],
            ["-160479", "8505769707925446487896"],
            ["-410339", "119942811102"],
            ["83955", "350603795065398382366739343617249"],
            ["37198", "3268040488594410434406498175721"],
            ["131638", "41262872257428686694501508138557248"],
            ["287001", "230436606285014985715185403186208542050648"],
            ["-210831", "55343086410670785162"],
            ["-131910", "148042868953454631562786"],
            ["29249", "1475992003797613797671655888654"],
            ["17346", "448920179814505453726992301850"],
            ["-424253", "29835072183"],
            ["-101498", "3098117156408863626880949"],
            ["263480", "21933022872353178717246305550749995374516"],
            ["270986", "46458333972720195629181368018167372142458"],
            ["408282", "42604457123409828539340920765145023701372141463"],
            ["-128622", "205672572011497627869313"],
            ["287624", "245248671829896859080313505278959346803282"],
            ["-379956", "2502794408855"],
            ["491712", "178892756297030712337181287021113859848684757554342"],
            ["432806", "494840883436574870448890765062576545067719496532"],
            ["-30300", "3828539170522754258265292944"],
            ["218624", "247243316511282007357900296739997143552"],
            ["284436", "178303761621007815812432356932173622146833"],
            ["253939", "8448096051459462601675346808169375325097"],
            ["128208", "29282213024769917825285962270451645"],
            ["-151800", "20259044387978934330208"],
            ["-111458", "1144358656497567838664484"],
            ["-91402", "8502362630752363791329962"],
            ["208027", "85689124906072707257085730363094089281"],
            ["317969", "5098088619470561486704431639942403116999722"],
            ["476654", "39688511347184359870668950259983776065521764581316"],
            ["-384032", "1665005205452"],
            ["326848", "12387913715836935848136077958147754551913895"],
            ["-334573", "234037409282860"],
            ["335200", "28556356040985388735390696113574181904911641"],
            ["285712", "202569338891893641986670337054780170251632"],
            ["-55920", "295410727102753704863725751"],
            ["-284228", "35944424585279778"],
            ["5037", "131106063361133493313739850069"],
            ["433793", "546170571333141894224836620971204864815376430316"],
            ["-442905", "4620846318"],
            ["284747", "183935852093261338123464167470835735762666"],
            ["306942", "1692523855120982001368435781115676022232028"],
            ["-453837", "1548725803"],
            ["-268376", "175404498971933645"],
            ["131487", "40644514156083618134012068403620524"],
            ["186085", "9550902216791273872412500806701365620"],
            ["179206", "4800739726366978142615871590737467514"],
            ["-175128", "1965836712361123759283"],
            ["278750", "100979451929093604517408991479092984516121"],
            ["450259", "2834012991001020803709630925710123583092085259398"],
            ["-90751", "9074250857898044404421707"],
            ["-477510", "145184618"],
            ["129534", "33434009757566044248695727980054183"],
            ["92186", "798484570737302662295939822807470"],
            ["368737", "816814375036693275674511722786676773215739034"],
            ["-395530", "527337633920"],
            ["384265", "3858887587216489013386655285431849959791635163"],
            ["-162627", "6861701627778328602670"],
            ["-382708", "1900698842268"],
            ["158102", "581860546181443639958405655247244320"],
            ["-221800", "18480323767272845298"],
            ["285075", "190068669826767615483686486222226457720481"],
            ["-250460", "1052164926620216908"],
            ["-138273", "78353739812335269125577"],
            ["474547", "32148709064013268980666587906291439913717046657689"],
            ["-18645", "12279424314593251484228494668"],
            ["46292", "8113627856505353726390885840807"],
            ["126324", "24254197302762788565863384874081429"],
            ["418237", "115285205209668943803694976155161607595996545468"],
            ["-454482", "1451991054"],
            ["-272442", "116806072314514288"],
            ["-59078", "215418462183253689587616659"],
            ["259353", "14516907845682493776291690469560956682909"],
            ["-189486", "467755174068846640437"],
            ["-424999", "27690471093"],
            ["-428003", "20505709696"],
            ["-33424", "2801342962822211916598257438"],
            ["442028", "1244376843796770384677583806948346572625053948886"],
            ["-312380", "2153113070655440"],
            ["170221", "1954852880579514117136508779527520281"],
            ["405458", "32123022797708144268403612726660207675435608299"],
            ["-37126", "1934632605587493637683527382"],
            ["-236971", "4053912385281389312"],
            ["305332", "1440843735996401560677284039711755270474960"],
            ["-210726", "55927220951624626604"],
            ["-441918", "5100165241"],
            ["371871", "1117440629321729483077292817025025635642431654"],
            ["214710", "167166865394494257190087849646673514297"],
            ["-263895", "274560689032814278"],
            ["395706", "12114726163480681254842750130687522981657583994"],
            ["-366792", "9334731889372"],
            ["288995", "281284279374322910550499099797865063840051"],
            ["-78341", "31386528769713413625642736"],
            ["-133471", "126647760207603575263957"],
            ["196003", "25748748817009679038753485860564810907"],
            ["87156", "482866777672938214145833877758850"],
            ["115689", "8374093713241540929629404267548060"],
            ["-245338", "1755975017347624559"],
            ["296246", "580813423731132453662785305419391359312763"],
            ["-409511", "130296277536"],
            ["-234271", "5310409424873769356"],
            ["184184", "7897491104774854876779512383733269916"],
            ["-264653", "254519159390146968"],
            ["-99901", "3634554603892500854824290"],
            ["-429964", "16854423987"],
            ["258130", "12845841535139630665296159136319682866820"],
            ["-329476", "389613603604878"],
            ["158962", "634112578911430234078064517579097372"],
            ["-135639", "101964073501874702470241"],
            ["-269206", "161434401763107498"],
            ["-363593", "12853627428205"],
            ["54674", "18759554428626042946318232229855"],
            ["119835", "12676148158772359960914091860058261"],
            ["-169696", "3384109516724972035657"],
            ["-226604", "11431018761593202077"],
            ["-334875", "227075481813081"],
            ["161134", "787935039012694273584065875420426173"],
            ["142713", "124886802562650438786519376174679612"],
            ["52150", "14575117753049946945915617136895"],
            ["411049", "56184731642774998196565485601571815634739379064"],
            ["209925", "103597834897980167394837860794531531437"],
            ["412167", "62830426302181884481683714498639494367745883950"],
            ["271152", "47235939709196279756805471139137579400392"],
            ["298633", "737390528691550431224298803776841835210165"],
            ["-173591", "2292425157680714733662"],
            ["97727", "1389623243449552972338309148359720"],
            ["-46258", "776283956426351772525023768"],
            ["6094", "145722095877611282056007278250"],
            ["-83463", "18806534497131303702069610"],
            ["405703", "32919716673307850764093074422018134088042221238"],
            ["-410849", "113979385702"],
            ["32928", "2132322827584590722659129946570"],
            ["-465311", "491688396"],
            ["373477", "1312105223974313123145426001633472545825729075"],
            ["-43127", "1061674568877388943509393460"],
            ["-281631", "46602817467230253"],
            ["129570", "33554583065870653486260796553897582"],
            ["190538", "14908229254899551105078996820637386584"],
            ["492958", "202629719102904329360111703857435514261416490307552"],
            ["65050", "52944876994754027744532437857862"],
            ["452012", "3376990611106133839773249630145450926020459906271"],
            ["-106219", "1932313831945947157699209"],
            ["-272335", "118062544605297255"],
            ["243196", "2885490226474110545643397916835817139317"],
            ["-96881", "4915883408131896046393075"],
            ["-74986", "43897703511601545490457007"],
            ["-295681", "11435599413440117"],
            ["73105", "118476075218371495596088328951203"],
            ["129777", "34256366245174715178130230563041712"],
            ["-142844", "49608220370194670989821"],
            ["406045", "34064986208448079208454274856476585928242620237"],
            ["267623", "33190798410189700421210982645707308448118"],
            ["232726", "1012828745848145001205837473318957650181"],
            ["372", "82230802902302458437476776354"],
            ["-95283", "5767642886237476945672873"],
            ["-354046", "33390730443093"],
            ["-116423", "696539467493308031450405"],
            ["362885", "454974386498940780658045836345424649304953683"],
            ["-367344", "8833442611735"],
            ["438433", "868622071555237200809094331283174286553586280428"],
            ["-482658", "86767480"],
            ["499173", "377227789992795153956611239451610092095235068506811"],
            ["-13851", "19832084852701902383515313924"],
            ["226695", "554148436360906033350323784830454037946"],
            ["297651", "668423898718523527433453591717999448223833"],
            ["379029", "2286003577555722063687686057509918586156562915"],
            ["-392735", "697377618467"],
            ["169620", "1840832550723161597412661306088200592"],
            ["47590", "9238121921961863232027953945776"],
            ["-444235", "4045416548"],
            ["472829", "27074190254099388504303934683497047145689715763410"],
            ["242196", "2610912579950859253719540689137636132380"],
            ["433345", "522243298571841990998808435257354888349769552357"],
            ["92919", "859208812128801904519724793060061"],
            ["-295826", "11270987770778351"],
            ["99040", "1584590632527078966090287593235671"],
            ["433737", "543120716164044266568297792419162405654967443570"],
            ["-38997", "1604523447290941556736570492"],
            ["159556", "672918039303489053893445070657031833"],
            ["-343917", "91939218312683"],
            ["282821", "151713928201053742617302909544214280935340"],
            ["475063", "33851039855794215135137526711230996092376062317821"],
            ["117804", "10346334311922660757621342346265048"],
            ["268381", "35804331991690925186334219811695213905267"],
            ["348102", "103753203322330929106219852052306612255193992"],
            ["-142483", "51431701774965357670612"],
            ["-345137", "81380345476380"],
            ["337746", "36835675208078935000132570705222477552124656"],
            ["-401209", "298858258179"],
            ["131803", "41949322973115590060865874467156380"],
            ["27289", "1213295374852603148796475012735"],
            ["431164", "419911709112350835117133074423145174125538910278"],
            ["15617", "377644676064285914808832309598"],
            ["-354914", "30614772978385"],
            ["255962", "10342183141141525650477912198094957427193"],
            ["-361541", "15781143884800"],
            ["-29703", "4064051278815123597667504999"],
            ["384011", "3762110947298783642447423819517937329176942533"],
            ["-374240", "4432568855533"],
            ["379698", "2444160684277837743077248617160992175733661204"],
            ["-443495", "4356115953"],
            ["-319536", "1052691810094189"],
            ["98544", "1507916019120754121939303313995660"],
            ["207037", "77612684196820174717396682146409244411"],
            ["203183", "52791497138036302925186760483181026610"],
            ["481368", "63588853308816016155093560593878317302124541835798"],
            ["-471317", "269690553"],
            ["165662", "1239164957239371014525679711215838654"],
            ["-20700", "9998502342379996075927724536"],
            ["210714", "112102371626556519823118585961810050255"],
            ["-146527", "34325034853179392221976"],
            ["182926", "6963981859039868212775695063355189035"],
            ["-185615", "688851468977148313946"],
            ["-490868", "38178516"],
            ["-325135", "601384071471345"],
            ["299471", "801843500108628620250252689956941923355520"],
            ["148598", "224950038059971460113684333595616915"],
            ["132748", "46106667426980898018867666415662385"],
            ["299035", "767635976354693116263650344515070303796326"],
            ["376392", "1756140168222259247742225605612580110098448987"],
            ["-88005", "11941588001420239342327614"],
            ["355739", "222666881920216517264676743908563756855194975"],
            ["-426968", "22741653398"],
            ["-384163", "1643336957536"],
            ["200874", "41907369014071903784234290647655630724"],
            ["-476283", "164136768"],
            ["-255105", "661247616623184336"],
            ["-111034", "1193920267245219729306671"],
            ["-159797", "9106070805849819751682"],
            ["-179308", "1294259686611022516706"],
            ["263043", "20995236521034591704585251097784238296238"],
            ["-183665", "837160596496029921449"],
            ["392412", "8714934993708248504658637840984847582308459923"],
            ["-306018", "4067721142704572"],
            ["-427969", "20575544269"],
            ["196235", "26353072625719572784267777053102145704"],
            ["-89284", "10507964486332748255222619"],
            ["429536", "356827550127256686640000851142852761927461245653"],
            ["290727", "334473337840323138266614906815036133864727"],
            ["-365033", "11129878637697"],
            ["86797", "465840167858336762185845272761164"],
            ["105933", "3156903478359114446665609774939396"],
            ["-131719", "150897520160401273629515"],
            ["-192783", "336386740216674613719"],
            ["-256409", "580410085913630717"],
            ["420681", "147200688597935340595933805174021701345290491570"],
            ["285144", "191384612634477177979149618575289979888088"],
            ["-388943", "1018929741299"],
            ["451512", "3212300865809430965684714067369948318280159270748"],
            ["64022", "47772800735477141708142976090377"],
            ["379991", "2516830371303046422929975961900811597304267316"],
            ["-304257", "4850947867405815"],
            ["-164726", "5562601841868318298604"],
            ["478102", "45871982290812888000183963056878841080305130222425"],
            ["347218", "94975546550577201632636405173596922916581752"],
            ["141672", "112540476964276254409684603931918094"],
            ["333134", "23226407113950075410035844491336541321506282"],
            ["290571", "329296298509132651791466350873517731468478"],
            ["-262769", "307282246908195821"],
            ["215192", "175421227798901113201834250232152529122"],
            ["10852", "234505154049183577554138842241"],
            ["-98960", "3993155893086756106517114"],
            ["151730", "307680733412658389948096408556597293"],
            ["-285454", "31797259718531858"],
            ["-48140", "643117719392791228523268359"],
            ["-84904", "16282836760753029725491258"],
            ["13854", "316607411720063491511115427269"],
            ["-70266", "70375022661989106067441213"],
            ["51523", "13689360785098666375092810804156"],
            ["234952", "1265333881499711563724319880845207815408"],
            ["368865", "827336269423929957511312974301281689831916687"],
            ["157005", "521409797606264442283776007979460721"],
            ["195524", "24544515575550976600096275952140437964"],
            ["457226", "5688001139664741963729542474895655768879607596429"],
            ["341195", "52005504394930150092698050467524685845326091"],
            ["347217", "94966049945583065481926276664295465295825315"],
            ["24781", "944171597062335717451852029487"],
            ["-338651", "155664236876879"],
            ["351806", "150264415954408181062870878897957685367306412"],
            ["-421452", "39479068352"],
            ["213061", "141755076069968466949023160162296179077"],
            ["-66547", "102076222611792351150596226"],
            ["476119", "37621076442958446913954155839565871058438647931958"],
            ["-41817", "1210266876012968260315798601"],
            ["-491222", "36850703"],
            ["-91558", "8370761511118538608119841"],
            ["54440", "18325698457967431813253183058050"],
            ["-281982", "44995512152706965"],
            ["210301", "107567069039292827818009988426349854598"],
            ["252054", "6996783342893033322020420665830547455360"],
            ["79067", "215052295898383078265731617582128"],
            ["464834", "12171788491551820626858412236863032444318505005439"],
            ["211629", "122843097564410113683667600541643504846"],
            ["72235", "108604776931450902134236585105798"],
            ["91877", "774189897850010041563598332962790"],
            ["353936", "185932901866121568207959200928211745231543586"],
            ["92601", "832317159744289205225194554449771"],
            ["426834", "272344040363705880706138530736113061868102797189"],
            ["-125983", "267781742187534992227537"],
            ["-362842", "13856054801528"],
            ["50243", "12044707425841429407187728897660"],
            ["-17883", "13251638855020514091293478965"],
            ["84577", "373102688902768274220346644586259"],
            ["48964", "10598704114055632944156924029402"],
            ["326842", "12380483568375758316873975803268793676776170"],
            ["-20743", "9955603226424180081350158972"],
            ["343497", "65466467009545750931553653966576586730439367"],
            ["287264", "236577176580485340352320455945580032025651"],
            ["-138996", "72888969281251813965083"],
            ["-417712", "57383219511"],
            ["495085", "250653026418995013209116124111993743243712869630914"],
            ["-196240", "238073344044953923223"],
            ["-486304", "60258891"],
            ["111960", "5767631449759352256347758826354539"],
            ["-415557", "71182082986"],
            ["375748", "1646614783867748010340289545073535979733877689"],
            ["-26325", "5697135126711196026633909427"],
            ["-59846", "199494429164084048527157190"],
            ["346074", "84709281231136869172369186953349453865002187"],
            ["202628", "49941529618459618306023543708292243019"],
            ["-399746", "345938873605"],
            ["11108", "240585680654530724688086874261"],
            ["-442724", "4705240884"],
            ["454080", "4152766015747703527402969047665108741159510410664"],
            ["159190", "648735684535856800683914786101315711"],
            ["-331744", "310556803680897"],
            ["-128385", "210604983568502862052407"],
            ["-442001", "5058011159"],
            ["-23836", "7307133004406007382710529950"],
            ["106133", "3220673938496241944621180266054325"],
            ["51458", "13600672922108841320677773242637"],
            ["456960", "5538702250670975075847459150235989862532384168330"],
            ["-454559", "1440854211"],
            ["-4068", "52749387534037183892269087455"],
            ["-330799", "341334215898500"],
            ["-421150", "40689460634"],
            ["29023", "1443010330207386317907505136081"],
            ["456093", "5078746899496654955682372471184508233221513937181"],
            ["471274", "23175337145337039032582328675026997117456252144644"],
            ["67282", "66184093615424722411717488700987"],
            ["-311783", "2285561551936795"],
            ["-224715", "13807627542804718121"],
            ["-333272", "266553364808524"],
            ["-398214", "403208756519"],
            ["391481", "7940235021505384317771105070706113778131954556"],
            ["259169", "14252252271562499744443906410565126642890"],
            ["450430", "2882888868081687617865067386789979042716941483501"],
            ["93931", "950707952521235040614656883238465"],
            ["135608", "61371359590667587299316887122184942"],
            ["-290359", "19470580558902173"],
            ["-243010", "2216241246845688397"],
            ["56360", "22204495374339446788946121752612"],
            ["115447", "8173882976038749865890870439412647"],
            ["428686", "327751881059136251364820917499011007554839559588"],
            ["254471", "8909680986026189851799715031661150547642"],
            ["-459408", "887240125"],
            ["-161404", "7754314104104727087417"],
            ["455579", "4824307142336892199518130329487710213415123833464"],
            ["-369384", "7203413527457"],
            ["355804", "224118857865022353722157670511890804986793572"],
            ["-478931", "125953560"],
            ["-220971", "20077553328520316706"],
            ["-74894", "44303405466738200082537382"],
            ["-494293", "27106947"],
            ["287314", "237762965176166921914595198104461890030513"],
            ["399544", "17782281891351804337482677685814863389950058895"],
            ["283097", "155959337519378943297411792589823255121846"],
            ["-58838", "220650780345749231228677810"],
            ["127853", "28260979658621690349011466290710677"],
            ["358865", "304375221822711473225885656542436853851882896"],
            ["-253136", "805141899432816228"],
            ["-12677", "22302420243823658932599105277"],
            ["-363421", "13076610831270"],
            ["42552", "5582093013653138099791017222430"],
            ["-405183", "200856209564"],
            ["178646", "4539300001678670513281518951358432485"],
            ["-466376", "442017953"],
            ["-441510", "5312544441"],
            ["-177067", "1619354570948318017574"],
            ["65842", "57308408369548776656949874477997"],
            ["252422", "7259047930018606764775059335587405507370"],
            ["416296", "94946996829623933560277505472663102109190043829"],
            ["153210", "356757138517790804989670471842661516"],
            ["35922", "2876565206924601078759926535970"],
            ["-475103", "184692842"],
            ["-126339", "258416864215301115425352"],
            ["359098", "311550068137537594223352722004582584396467301"],
            ["204303", "59047637835944873278263208736811375944"],
            ["-205534", "93993465261211581007"],
            ["321628", "7350346060709690027816720154995511607751097"],
            ["-339275", "146248097830911"],
            ["242662", "2735454162558370276684849754015962972298"],
            ["445899", "1832562982377562890328779339590297488178148240295"],
            ["1724", "94134367538567653048626699791"],
            ["432979", "503475674582890856853829389083749975622680079379"],
            ["149140", "237478148911972709373790277772809236"],
            ["-151092", "21745303224613550621288"],
            ["-163290", "6421545215115168565147"],
            ["479771", "54203537862812894404530805418770906956186026328728"],
            ["-174564", "2079890280778414876780"],
            ["-332958", "275055500374813"],
            ["197682", "30455836231766078398115296288139266707"],
            ["245914", "3786648090564782661383532525734899507960"],
            ["474778", "32899950134016148303442215744583678194656711432379"],
            ["119132", "11815658515797699773018630346737214"],
            ["-315306", "1606936166398115"],
            ["399276", "17312069238466062937454881367546304876644271686"],
            ["296923", "621493959051293881862655942968589055968718"],
            ["223403", "398715865004834529737818220051408602559"],
            ["57160", "24053746474505909233594699775792"],
            ["-336133", "200234418120831"],
            ["345", "82009090266655072568631321420"],
            ["-278637", "62868549516372192"],
            ["240095", "2116175207856414369688325421041281491840"],
            ["356605", "242808367682628589731607791588986635962855717"],
            ["214207", "158966743881566755526767830000679399754"],
            ["-427141", "22351625761"],
            ["-327073", "495438621281695"],
            ["-135647", "101882538937907338569978"],
            ["294257", "476057916460072582597545726788196706053330"],
            ["463714", "10882178545190626350874863259776626727833115300560"],
            ["-112848", "995859898233876269648885"],
            ["444601", "1609497491582963456360656514408813508316010407670"],
            ["-199520", "171502045450552281798"],
            ["-335323", "217127496191690"],
            ["458146", "6236095670929015599786846634266232015129899293797"],
            ["-166393", "4708523092667154686697"],
            ["403064", "25284333213930086600558629937941314167164783932"],
            ["-40581", "1369484941976342653200297760"],
            ["231609", "905790477414693357784340116313987626357"],
            ["-50759", "494942146499329117663511942"],
            ["269298", "39242655541057594426207073063045049894023"],
            ["409566", "48441285462325085265985571218831558586390998462"],
            ["206631", "74524870347241641039928625885915045856"],
            ["130673", "37467277180264632707955398178811097"],
            ["-304165", "4895780259003530"],
            ["-427069", "22513130110"],
            ["-146620", "34007307636599111380735"],
            ["-71269", "63659172507445772460779306"],
            ["384877", "4102415277371686947105131198202354904182788847"],
            ["-22248", "8564648188921561106085667886"],
            ["-332119", "299127140516136"],
            ["308414", "1960919431200394877140435248484139245046774"],
            ["-293636", "14030324473574923"],
            ["342973", "62124514986042191947029307963345084487139516"],
            ["-450138", "2241878289"],
            ["18148", "486404746466328874283687180814"],
            ["486014", "101191521499999351363280789446920102360607519810116"],
            ["-460510", "794665421"],
            ["-195596", "253908908480894066087"],
            ["189158", "12986628601644282460558197867298783262"],
            ["290217", "317843689257790543801912766301628628887275"],
            ["120370", "13372755358994984607953481064797480"],
            ["-257427", "524234963813160327"],
            ["103678", "2519606930779949460560622917268534"],
            ["457389", "5781470593657983515217341002823917932262081292921"],
            ["-228310", "9638245921971296831"],
            ["-200492", "155617341231278967462"],
            ["299407", "796728343421753316544607460971721248450244"],
            ["-21472", "9255696277371362562518930661"],
            ["482769", "73151394868403633133693077561662950920024474664657"],
            ["-151094", "21740954816240754308019"],
            ["188213", "11815650706159682715586852483148506489"],
            ["-29640", "4089734334423041711529067472"],
            ["-492253", "33240861"],
            ["-126123", "264059103198544780842179"],
            ["403543", "26524864299207129757902170853949640510623072045"],
            ["-254904", "674672490511074988"],
            ["-279155", "59695021251544634"],
            ["-136682", "91865517867508304841352"],
            ["145827", "170509698628366072730713592144748998"],
            ["-371856", "5625823705390"],
            ["-88577", "11277729692013701228033139"],
            ["-48177", "640742699077025031467140369"],
            ["319171", "5749194047811744370090334711739005964162789"],
            ["63478", "45243507314615136498125874992176"],
            ["85607", "413578995556550607749280650934592"],
            ["524287", "4647684107270898330752324302845848816923571339324334"],
        ];

        for [x_str, expected_str] in data {
            let x = x_str.parse().unwrap(); // ok for decimal or 0x-hex
            let expected: U256 = expected_str.parse().unwrap();

            let actual = to_price(x);
            assert_eq!(actual, expected, "to_price({}) failed", x_str);
        }
    }
}
